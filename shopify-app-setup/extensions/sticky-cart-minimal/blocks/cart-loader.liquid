{% comment %}
Minimal cart loader - loads cart drawer via app proxy
{% endcomment %}

<script>
(function() {
  // Only load on storefront, not in theme editor
  if (window.Shopify && window.Shopify.designMode) {
    console.log('Sticky Cart: Theme editor detected, skipping load');
    return;
  }

  console.log('Sticky Cart: Starting to load from proxy...');

  var shopDomain = '{{ shop.domain }}';
  var proxyBases = ['/tools/cart-drawer', '/apps/cart-drawer']; // Try both prefixes just in case
  var chosenBase = null;

  function testBase(base) {
    console.log('[Sticky Cart] Testing URL:', base + '/test?shop=' + shopDomain);
    return fetch(base + '/test?shop=' + shopDomain, { 
      credentials: 'include',
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    })
      .then(function(r) {
        console.log('[Sticky Cart] Response status:', r.status, 'Headers:', [...r.headers.entries()]);
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      })
      .catch(function(err) {
        console.error('[Sticky Cart] Request failed:', err);
        throw err;
      });
  }

  function tryNextBase(i) {
    if (i >= proxyBases.length) {
      console.error('Sticky Cart: No working app proxy found (tried ' + proxyBases.join(', ') + ')');
      showFallback();
      return;
    }

    var base = proxyBases[i];
    console.log('Sticky Cart: Testing app proxy base', base);
    testBase(base)
      .then(function(data) {
        console.log('Sticky Cart: App proxy test successful at', base, data);
        chosenBase = base;
        loadMainScript();
      })
      .catch(function(err) {
        console.warn('Sticky Cart: App proxy test failed at', base, err);
        tryNextBase(i + 1);
      });
  }

  function loadMainScript() {
    var base = chosenBase || proxyBases[0];
    var script = document.createElement('script');
    script.src = base + '/script?shop=' + shopDomain;
    script.async = true;
    script.defer = true;

    script.onload = function() {
      console.log('Sticky Cart: Script loaded successfully from', script.src);
    };

    script.onerror = function() {
      console.error('Sticky Cart: Failed to load from proxy:', script.src);
      showFallback();
      console.error('Sticky Cart: App proxy not working. Verify App Proxy config: prefix="tools" or "apps", subpath="cart-drawer", URL points to "/proxy" on your app.');
    };

    document.head.appendChild(script);
    console.log('Sticky Cart: Script element created and appended', script.src);
  }

  function showFallback() {
    var fallbackBtn = document.createElement('div');
    fallbackBtn.innerHTML = 'ðŸ›’ Cart (Proxy Error)';
    fallbackBtn.style.cssText = 'position:fixed;bottom:20px;right:20px;background:red;color:white;padding:10px;border-radius:20px;z-index:999999;cursor:pointer;font-size:12px;';
    fallbackBtn.onclick = function() { 
      console.error('Sticky Cart: App Proxy Error. Please check configuration:');
      console.error('1. Shopify Admin -> Apps -> Your App -> App setup');
      console.error('2. App Proxy URL should be: https://mjfzxmpscndznuaeoxft.supabase.co/functions/v1/app-proxy');
      console.error('3. Subpath: cart-drawer, Prefix: tools');
      console.error('4. Test URLs tried:', proxyBases.map(base => window.location.origin + base + '/test?shop=' + shopDomain));
      window.location.href = '/cart'; 
    };
    document.body.appendChild(fallbackBtn);
    
    // Also show detailed error information in console
    console.error('Sticky Cart: Complete proxy configuration check:');
    console.error('Shop Domain:', shopDomain);
    console.error('Current URL:', window.location.href);
    console.error('Expected proxy URLs:', proxyBases.map(base => window.location.origin + base + '/test?shop=' + shopDomain));
    console.error('Supabase Function URL should be: https://mjfzxmpscndznuaeoxft.supabase.co/functions/v1/app-proxy');
  }

  // Start trying bases
  tryNextBase(0);
})();
</script>

{% schema %}
{
  "name": "Sticky Cart Loader",
  "target": "head",
  "settings": [
    {
      "type": "paragraph",
      "content": "This loads the Sticky Cart Drawer. No configuration needed - settings are managed in the app dashboard."
    }
  ]
}
{% endschema %}